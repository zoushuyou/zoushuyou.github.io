---

title:      "Redis相关知识----缓存问题"
date:       2021-05-11
author: "shuyou"
categories: ["Code"]
tags:
    - Redis
---

>本文介绍Redis缓存相关问题，包括缓存穿透、缓存击穿、缓存雪崩等相关知识

**缓存穿透**：
缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。当流量过大时，数据库可能挂掉。

解决方案：

 1. 用户校验：接口层增加校验，如用户鉴权校验，id做基础校验，id<=0的直接拦截；
 2. 对空值缓存：从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击。
 3. 布隆过滤器：bloomfilter就类似于一个hash set，用于快速判某个元素是否存在于集合中，其典型的应用场景就是快速判断一个key是否存在于某容器，不存在就直接返回。

**缓存击穿**：
缓存击穿是指缓存中没有但数据库中有的数据（一般是热门缓存数据时间到期），这时由于大量并发请求，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，可能造成数据库宕机。

解决方案：

 1. 设置热点数据永远不过期。
 2. 接口限流与熔断，降级。重要的接口一定要做好限流策略，防止用户恶意刷接口，同时要降级准备，当接口中的某些 服务 不可用时候，进行熔断，失败快速返回机制。
 3. 加互斥锁。

**缓存雪崩**：
缓存雪崩是指缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。和缓存击穿不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。

解决方案：

 1. 缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。
 2. 如果缓存数据库是分布式部署，将热点数据均匀分布在不同的缓存数据库中。
 3. 设置热点数据永远不过期。
 4. 使用锁或者队列。

**缓存污染**：
缓存污染问题说的是缓存中一些只会被访问一次或者几次的的数据，被访问完后，再也不会被访问到，但这部分数据依然留存在缓存中，消耗缓存空间。 缓存污染会随着数据的持续增加而逐渐显露，随着服务的不断运行，缓存中会存在大量的永远不会再次被访问的数据。缓存空间是有限的，如果缓存空间满了，再往缓存里写数据时就会有额外开销，影响Redis性能。这部分额外开销主要是指写的时候判断淘汰策略，根据淘汰策略去选择要淘汰的数据，然后进行删除操作。


**缓存一致性问题**：
读取缓存步骤一般没有什么问题，但是一旦涉及到数据更新：数据库和缓存更新，就容易出现缓存(Redis)和数据库（MySQL）间的数据一致性问题。 

不管是先写MySQL数据库，再删除Redis缓存；还是先删除缓存，再写库，都有可能出现数据不一致的情况。

解决方案：

 1. 读的时候，先读缓存，缓存没有的话，就读数据库，然后取出数据后放入缓存，同时返回响应。
 2. 更新的时候，先更新数据库，然后再删除缓存。

**参考**：

 1. [Redis进阶 - 缓存问题：一致性, 穿击, 穿透, 雪崩, 污染等](https://www.pdai.tech/md/db/nosql-redis/db-redis-x-cache.html#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7)
